{% extends "base.html" %}
{% block content %}
<div class="card">
    <h2>Keyword responses</h2>
    <p class="small">Chaque entr√©e correspond √† un embed d√©clench√© par un ou plusieurs mots-cl√©s.</p>
</div>

<div class="card">
    <h2>√âditer un embed</h2>
    <form id="embed-form" onsubmit="saveEmbed(event)">
        <div class="row">
            <div class="col">
                <label>Nom interne (facultatif)</label>
                <input type="text" id="name" placeholder="egirl_warning">
            </div>
            <div class="col">
                <label>Couleur (nom ou hex)</label>
                <input type="text" id="color" placeholder="red ou #ff0000">
            </div>
        </div>
        <label>Triggers (s√©par√©s par des virgules)</label>
        <input type="text" id="triggers" placeholder="egirl, e-girl, e girl">

        <label>Titre</label>
        <input type="text" id="title" placeholder="√Ä propos du terme ¬´ egirl ¬ª">

        <label>Description</label>
        <textarea id="description" placeholder="Texte principal de l'embed..."></textarea>

        <div class="card" style="margin-top:0.75rem;">
            <h3>Champs de l'embed</h3>
            <p class="small">Ajoute des champs comme dans un embed Discord, sans JSON.</p>
            <div class="row">
                <div class="col">
                    <label>Nom du champ</label>
                    <input type="text" id="field_name" placeholder="Titre du champ">
                </div>
                <div class="col">
                    <label>Inline ?</label>
                    <input type="checkbox" id="field_inline"> <span class="small">Afficher sur la m√™me ligne</span>
                </div>
            </div>
            <label>Valeur</label>
            <textarea id="field_value" placeholder="Contenu du champ..."></textarea>
            <div style="margin-top:0.5rem;">
                <button type="button" onclick="addField()">‚ûï Ajouter le champ</button>
            </div>
            <div id="fields_list" class="small" style="margin-top:0.5rem;"></div>
        </div>

        <label>Footer</label>
        <input type="text" id="footer" placeholder="Texte de bas de l'embed">

        <label>Image URL (optionnel)</label>
        <input type="text" id="image_url" placeholder="https://...">

        <label>Thumbnail URL (optionnel)</label>
        <input type="text" id="thumbnail_url" placeholder="https://...">

        <div style="margin-top:0.75rem; display:flex; gap:0.5rem; align-items:center; flex-wrap:wrap;">
            <button type="submit">üíæ Enregistrer</button>
            <button type="button" class="secondary" onclick="resetForm()">R√©initialiser</button>
            <button type="button" class="danger" onclick="deleteCurrentEmbed()">üóëÔ∏è Supprimer l'embed courant</button>
            <span id="status" class="status"></span>
        </div>
    </form>
</div>

<div class="card">
    <h2>Pr√©visualisation de l'embed</h2>
    <div id="embed-preview" class="embed-preview">
        <!-- preview remplie par JS -->
    </div>
</div>

<div class="card">
    <h2>Liste des embeds</h2>
    <table>
        <thead>
        <tr>
            <th>Nom</th>
            <th>Triggers</th>
            <th>Titre</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody id="embed-table-body">
        {% for e in embeds %}
            <tr>
                <td>{{ e.name or '(sans nom)' }}</td>
                <td>
                    {% for t in e.triggers %}<span class="tag">{{ t }}</span>{% endfor %}
                </td>
                <td>{{ e.title }}</td>
                <td>
                    <button type="button" class="secondary" onclick="loadFromRow({{ loop.index0 }})">√âditer</button>
                    <button type="button" class="danger" onclick="deleteEmbed({{ loop.index0 }})">üóëÔ∏è</button>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
</div>

<script>
let embeds = {{ embeds | tojson | safe }};
let currentIndex = null;
let fieldsData = [];

function refreshTable() {
    const tbody = document.getElementById('embed-table-body');
    tbody.innerHTML = '';
    embeds.forEach((e, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${e.name || '(sans nom)'}</td>
            <td>${(e.triggers || []).map(t => `<span class="tag">${t}</span>`).join(' ')}</td>
            <td>${e.title || ''}</td>
            <td>
                <button type="button" class="secondary" onclick="loadFromRow(${idx})">√âditer</button>
                <button type="button" class="danger" onclick="deleteEmbed(${idx})">üóëÔ∏è</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function loadFromRow(index) {
    const e = embeds[index];
    currentIndex = index;
    document.getElementById('name').value = e.name || '';
    document.getElementById('color').value = e.color || '';
    document.getElementById('triggers').value = (e.triggers || []).join(', ');
    document.getElementById('title').value = e.title || '';
    document.getElementById('description').value = e.description || '';
    fieldsData = Array.isArray(e.fields) ? [...e.fields] : [];
    document.getElementById('footer').value = e.footer || '';
    document.getElementById('image_url').value = e.image_url || '';
    document.getElementById('thumbnail_url').value = e.thumbnail_url || '';
    renderFieldsList();
    updatePreview();
    setStatus('Embed charg√©.', true);
}

function resetForm() {
    currentIndex = null;
    document.getElementById('embed-form').reset();
    fieldsData = [];
    renderFieldsList();
    updatePreview();
    setStatus('Formulaire r√©initialis√©.', true);
}

function deleteCurrentEmbed() {
    if (currentIndex === null) {
        setStatus("Aucun embed s√©lectionn√© √† supprimer.", false);
        return;
    }
    if (!confirm('Supprimer cet embed ?')) {
        return;
    }
    embeds.splice(currentIndex, 1);
    currentIndex = null;
    persistEmbeds('Embed supprim√©.');
}

async function deleteEmbed(index) {
    if (!confirm('Supprimer cet embed ?')) {
        return;
    }
    embeds.splice(index, 1);
    if (currentIndex === index) {
        currentIndex = null;
        document.getElementById('embed-form').reset();
        fieldsData = [];
        renderFieldsList();
        updatePreview();
    }
    await persistEmbeds('Embed supprim√©.');
}

function addField() {
    const name = document.getElementById('field_name').value.trim();
    const value = document.getElementById('field_value').value.trim();
    const inline = document.getElementById('field_inline').checked;
    if (!name || !value) {
        setStatus('Nom et valeur du champ sont obligatoires.', false);
        return;
    }
    fieldsData.push({ name, value, inline });
    document.getElementById('field_name').value = '';
    document.getElementById('field_value').value = '';
    document.getElementById('field_inline').checked = false;
    renderFieldsList();
    updatePreview();
}

function removeField(index) {
    fieldsData.splice(index, 1);
    renderFieldsList();
    updatePreview();
}

function renderFieldsList() {
    const container = document.getElementById('fields_list');
    if (!container) return;
    if (!fieldsData.length) {
        container.innerHTML = '<em>Aucun champ pour le moment.</em>';
        return;
    }
    container.innerHTML = '';
    fieldsData.forEach((f, idx) => {
        const div = document.createElement('div');
        div.style.marginBottom = '0.25rem';
        const inlineLabel = f.inline ? ' (inline)' : '';
        div.innerHTML = `
            <strong>${f.name}</strong>${inlineLabel}: ${f.value}
            <button type="button" class="danger" style="margin-left:0.5rem;" onclick="removeField(${idx})">üóëÔ∏è</button>
        `;
        container.appendChild(div);
    });
}

function updatePreview() {
    const prev = document.getElementById('embed-preview');
    if (!prev) return;
    const title = document.getElementById('title').value.trim();
    const description = document.getElementById('description').value.trim();
    const footer = document.getElementById('footer').value.trim();
    const color = document.getElementById('color').value.trim();
    const thumbnail = document.getElementById('thumbnail_url').value.trim();

    const colorBar = color ? `<div class="embed-color" style="background:${color};"></div>` : '<div class="embed-color"></div>';

    let fieldsHtml = '';
    if (fieldsData.length) {
        fieldsHtml = fieldsData.map(f => `
            <div class="embed-field${f.inline ? ' inline' : ''}">
                <div class="embed-field-name">${f.name}</div>
                <div class="embed-field-value">${f.value}</div>
            </div>
        `).join('');
    }

    const thumbHtml = thumbnail ? `<div class="embed-thumb"><img src="${thumbnail}" alt="thumb" /></div>` : '';

    prev.innerHTML = `
        <div class="embed-wrapper">
            ${colorBar}
            <div class="embed-main">
                ${title ? `<div class="embed-title">${title}</div>` : ''}
                ${description ? `<div class="embed-description">${description}</div>` : ''}
                ${fieldsHtml ? `<div class="embed-fields">${fieldsHtml}</div>` : ''}
                ${footer ? `<div class="embed-footer">${footer}</div>` : ''}
            </div>
            ${thumbHtml}
        </div>
    `;
}

function setStatus(msg, ok) {
    const el = document.getElementById('status');
    el.textContent = msg;
    el.className = 'status ' + (ok ? 'ok' : 'err');
}

async function saveEmbed(event) {
    event.preventDefault();
    try {
        const name = document.getElementById('name').value.trim();
        const color = document.getElementById('color').value.trim();
        const triggers = document.getElementById('triggers').value.split(',').map(t => t.trim()).filter(Boolean);
        const title = document.getElementById('title').value.trim();
        const description = document.getElementById('description').value;
        const footer = document.getElementById('footer').value || null;
        const image_url = document.getElementById('image_url').value || null;
        const thumbnail_url = document.getElementById('thumbnail_url').value || null;

        const embed = { name, triggers, title, description, color, fields: fieldsData, footer, image_url, thumbnail_url };

        if (currentIndex === null) {
            embeds.push(embed);
        } else {
            embeds[currentIndex] = embed;
        }

        await persistEmbeds('Sauvegard√© avec succ√®s.');
    } catch (e) {
        setStatus('Erreur: ' + e, false);
    }
}

async function persistEmbeds(successMessage) {
    try {
        const resp = await fetch('/api/keywords', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ embeds }),
        });
        const data = await resp.json();
        if (!data.ok) {
            setStatus('Erreur sauvegarde: ' + (data.error || 'inconnue'), false);
            return;
        }
        refreshTable();
        setStatus(successMessage, true);
    } catch (e) {
        setStatus('Erreur: ' + e, false);
    }
}

// init
refreshTable();
renderFieldsList();
updatePreview();
</script>
{% endblock %}
